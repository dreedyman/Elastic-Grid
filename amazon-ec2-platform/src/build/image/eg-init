#!/bin/bash

# Copyright (C) 2007-2008 Elastic Grid, LLC.
#
# This file is part of Elastic Grid.
#
# Elastic Grid is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or any later version.
#
# Elastic Grid is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with Elastic Grid.  If not, see <http://www.gnu.org/licenses/>.

echo "Attempting to start Elastic Grid" | logger -t elastic-grid

wget -q -O - http://169.254.169.254/latest/user-data | tr ',' '\n' > /tmp/user-data
wget -q -O - http://169.254.169.254/2007-01-19/meta-data/public-hostname | tr ',' '\n' > /tmp/public-hostname
source /tmp/user-data

export EG_HOME=`ls -d /usr/local/elastic-grid-*`
export JAVA_HOME=`ls -d /usr/local/jdk*`

# Install Yum packages
if [ -e "$YUM_PACKAGES" ] ; then
    echo 'Yum packages to install:' $YUM_PACKAGES | logger -t elastic-grid
    yum -y install $YUM_PACKAGES
fi

[ ! -f /etc/hosts ] &&  echo "127.0.0.1 localhost" > /etc/hosts

mkdir -p /mnt/eg/logs

# not set on boot
export USER="root"

mkdir -p /var/log/eg
/root/eg-bootstrap

LOCAL_HOST=`cat /tmp/public-hostname`
MONITOR_HOST=`cat $EG_HOME/config/monitor-host`

echo "Local host name: $LOCAL_HOST" | logger -t elastic-grid
echo "Located Elastic Grid Monitor: $MONITOR_HOST" | logger -t elastic-grid

if [ "$MONITOR_HOST" == $LOCAL_HOST ]; then
  # Elastic Grid
  echo Starting Elastic Grid monitor | logger -t elastic-grid
  cat $EG_HOME/config/monitor-cybernode.config > $EG_HOME/config/cybernode.config
  "$EG_HOME"/bin/eg start monitor 2>&1 > /var/log/eg/rio-monitor.log &
  echo Starting Elastic Grid cybernode | logger -t elastic-grid
  "$EG_HOME"/bin/eg start cybernode 2>&1 > /var/log/eg/rio-agent.log &
else
  # Elastic Grid
  echo Starting Elastic Grid cybernode | logger -t elastic-grid
  cat $EG_HOME/config/cybernode-cybernode.config > $EG_HOME/config/cybernode.config 
  "$EG_HOME"/bin/eg start cybernode 2>&1 > /var/log/eg/rio-agent.log &
fi
